-- Создание таблиц 
CREATE TABLE Students (
    student_id SERIAL PRIMARY KEY, 
    full_name VARCHAR(255) NOT NULL, 
    email VARCHAR(255) UNIQUE NOT NULL, 
    start_year INT -- Год поступления студента
);

CREATE TABLE Courses (
    course_id SERIAL PRIMARY KEY,
    course_name VARCHAR(255) NOT NULL,
    credits INT CHECK (credits > 0) -
);

CREATE TABLE Enrollments (
    student_id INT REFERENCES Students(student_id) ON DELETE CASCADE, 
    course_id INT REFERENCES Courses(course_id) ON DELETE CASCADE,
    grade CHAR(1), 
    PRIMARY KEY (student_id, course_id)
);

-- Задание 1: INSERT

-- 1.1 Добавление студентов
INSERT INTO Students (full_name, email, start_year) VALUES
('Алексей Смирнов', 'alexey.smirnov@example.com', 2021),
('Елена Кузнецова', 'elena.kuznetsova@example.com', 2022),
('Дмитрий Новиков', 'dmitry.novikov@example.com', 2021),
('Ольга Морозова', 'olga.morozova@example.com', 2023);

-- 1.2 Добавление курсов
INSERT INTO Courses (course_name, credits) VALUES
('Введение в программирование', 5),
('Базы данных', 4),
('Веб-технологии', 4);

-- 1.3 Запись студентов на курсы
INSERT INTO Enrollments (student_id, course_id, grade) VALUES (1, 2, 'A');

INSERT INTO Enrollments (student_id, course_id, grade) VALUES (2, 2, 'B');

INSERT INTO Enrollments (student_id, course_id, grade) VALUES (2, 3, 'A');

INSERT INTO Enrollments (student_id, course_id) VALUES (3, 1);
INSERT INTO Enrollments (student_id, course_id) VALUES (3, 2);
INSERT INTO Enrollments (student_id, course_id) VALUES (3, 3);

-- Задание 2: UPDATE

-- 2.1 Изменение email Елены Кузнецовой
UPDATE Students SET email = 'elena.kuznetsova@newmail.com' WHERE student_id = 2;

-- 2.2 Проставление оценки Дмитрию Новикову за 'Введение в программирование' (course_id=1)
UPDATE Enrollments SET grade = 'A' WHERE student_id = 3 AND course_id = 1;

-- Задание 3: Удаление данных (DELETE)

1)
INNER JOIN соединяет Customers и Orders по customer_id, возвращая имена покупателей и даты заказов только для тех, у кого есть заказы.

2)
LEFT JOIN соединяет Customers и Orders по customer_id, включая всех покупателей; фильтр WHERE Orders.order_id IS NULL оставляет только тех, у кого нет заказов.

3)
INNER JOIN соединяет Orders → Order_Items → Products для получения деталей заказа; фильтр WHERE Orders.order_id = 1 ограничивает конкретным заказом.

4)
Подзапрос находит customer_id из заказов, связанных с продуктом 'Смартфон' через Order_Items и Products; внешний запрос фильтрует Customers по этим ID с помощью IN.

5)
Подзапрос вычисляет среднюю цену продуктов (AVG(Products.price)); внешний запрос фильтрует продукты, цена которых выше этого среднего.

6)
EXISTS проверяет наличие в Order_Items (связанных с Products) строк, где order_id совпадает с внешним и цена продукта > 100000, возвращая заказы с такими продуктами.

7)
Подзапрос находит customer_id заказчиков 'Ноутбука' через соединения; внешний запрос исключает их с NOT IN.
Подзапрос агрегирует уникальные customer_id заказчиков 'Ноутбука'; LEFT JOIN с фильтром WHERE laptop_orders.customer_id IS NULL оставляет покупателей без таких заказов.
8)
LEFT JOIN соединяет Products и Order_Items по product_id; фильтр WHERE Order_Items.product_id IS NULL оставляет продукты, не присутствующие в заказах.

9)
FULL OUTER JOIN последовательно соединяет Customers → Orders → Order_Items → Products, сохраняя все строки, включая те с NULL для отсутствующих связей.

10)
INNER JOIN соединяет таблицы для получения покупателей и продуктов; фильтр по максимальной цене (SELECT MAX(Products.price)) с DISTINCT для уникальности.
Вложенные подзапросы фильтруют customer_id через цепочку: заказы → элементы заказов → продукты с максимальной ценой.
11)
CROSS JOIN создаёт декартово произведение имён покупателей и категорий продуктов; DISTINCT убирает возможные дубликаты.

12)
Самосоединение Customers с алиасами: LEFT JOIN по recommended_by показывает для каждого покупателя его рекомендатора (или NULL, если нет).
